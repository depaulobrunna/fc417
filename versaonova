/* 
 * Analysis Example
 * Generic Payload Parse
 * 
 * Learn how to parse from a hexadecimal raw payload into temperature and humidity variables
 * Tutorial: https://tago.elevio.help/en/articles/118
 */

const Analysis = require('tago/analysis');
const Device = require('tago/device');
const Utils = require('tago/utils');

async function myAnalysis(context, scope) 
{
  context.log('analysis started')
  const env_vars = Utils.env_to_obj(context.environment);
  if (!env_vars.device_token) return context.log('Missing device_token environment variable');
  const device = new Device(env_vars.device_token);
  var data = {}
  data = scope.find(x => x.variable === "payload").value
  context.log('data', data);
  var pack = data.slice(0, 2);
  context.log('pack', pack);

  
    
  const variables = 
  [{
      variable: 'teste',
      value: pack,
      unit: 'Liters'
  }];

  device.insert(variables).then(context.log('Successfully Inserted')).catch(error => context.log('Error when inserting:', error));
  context.log('analysis finished')

}
module.exports = new Analysis(myAnalysis, '');